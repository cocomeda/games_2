<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR 空間移動ゲーム</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; color: white; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 40px; pointer-events: none; z-index: 5;
        }
        #stats { font-size: 24px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; }
        #msg { font-size: 32px; font-weight: bold; text-align: center; }
        #start-btn {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; font-size: 20px; background: #0f0; border: none; border-radius: 10px;
            z-index: 10; cursor: pointer; pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="overlay">
    <div id="stats">
        距離: <span id="dist-val">5.00</span> m<br>
        ポイント: <span id="points">0</span>
    </div>
    <div id="msg">5メートル歩こう！</div>
</div>

<button id="start-btn">ARを開始して計測</button>

<script type="module">
    let xrSession = null;
    let xrRefSpace = null;
    let initialPos = null;
    let points = 0;
    const targetDistance = 5.0; // 5メートル

    const distEl = document.getElementById('dist-val');
    const pointsEl = document.getElementById('points');
    const msgEl = document.getElementById('msg');
    const startBtn = document.getElementById('start-btn');

    async function startAR() {
        if (!navigator.xr) {
            alert("お使いのブラウザはWebXRに対応していません。AndroidのChromeなどで試してください。");
            return;
        }

        // ARセッションの開始（カメラ背景＋トラッキング）
        xrSession = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local-floor']
        });

        startBtn.style.display = 'none';
        
        // 参照空間の取得
        xrRefSpace = await xrSession.requestReferenceSpace('local-floor');

        // メインループ
        xrSession.requestAnimationFrame(onXRFrame);
    }

    function onXRFrame(time, frame) {
        const pose = frame.getViewerPose(xrRefSpace);
        if (pose) {
            const currentPos = pose.transform.position;

            // 最初の位置を記録
            if (!initialPos) {
                initialPos = { x: currentPos.x, y: currentPos.y, z: currentPos.z };
            }

            // 初期位置からの直線距離を計算（三平方の定理）
            const dx = currentPos.x - initialPos.x;
            const dy = currentPos.y - initialPos.y;
            const dz = currentPos.z - initialPos.z;
            const moved = Math.sqrt(dx*dx + dy*dy + dz*dz);

            // 残り距離
            let remaining = targetDistance - moved;
            if (remaining < 0) remaining = 0;

            // 表示更新
            distEl.innerText = remaining.toFixed(2);

            if (remaining <= 0) {
                points += 100;
                pointsEl.innerText = points;
                msgEl.innerText = "到達！+100pt";
                msgEl.style.color = "#0f0";
                
                // 次の地点を設定（今の場所をスタートにする）
                initialPos = { x: currentPos.x, y: currentPos.y, z: currentPos.z };
                setTimeout(() => {
                    msgEl.innerText = "次の5メートルへ！";
                    msgEl.style.color = "#fff";
                }, 2000);
            }
        }
        xrSession.requestAnimationFrame(onXRFrame);
    }

    startBtn.addEventListener('click', startAR);
</script>
</body>
</html>
