<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vibration Optimizer</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: #fff; padding: 20px; }
        .card { background: #333; padding: 20px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #444; }
        .score { font-size: 2em; color: #2ecc71; }
        button { padding: 20px 40px; font-size: 1.2em; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 50px; transition: 0.3s; }
        button:active { transform: scale(0.95); }
        .log { font-size: 0.8em; color: #aaa; text-align: left; height: 100px; overflow-y: scroll; background: #111; padding: 10px; }
    </style>
</head>
<body>

    <h1>AI振動最適化エンジン</h1>
    
    <div class="card">
        <p>現在の最高移動スコア</p>
        <div id="bestScore" class="score">0.00</div>
    </div>

    <div class="card">
        <p>試行回数: <span id="trialCount">0</span></p>
        <p>現在のパターン: <span id="currentPattern">---</span></p>
    </div>

    <button id="startBtn">学習開始 (Android用)</button>

    <div class="card">
        <p>学習ログ</p>
        <div id="log" class="log"></div>
    </div>

    <script>
        let bestPattern = [100, 50, 100];
        let bestScore = 0;
        let trialCount = 0;
        let isLearning = false;
        
        let currentAccel = 0;

        // 加速度センサーの取得
        window.addEventListener('devicemotion', (event) => {
            const acc = event.acceleration;
            // X, Y, Zの移動量の絶対値を合計
            currentAccel = Math.abs(acc.x || 0) + Math.abs(acc.y || 0) + Math.abs(acc.z || 0);
        });

        async function runTrial() {
            if (!isLearning) return;

            trialCount++;
            document.getElementById('trialCount').innerText = trialCount;

            // 1. 新しいパターンを生成 (最高パターンに少しノイズを混ぜる)
            let testPattern = bestPattern.map(v => Math.max(5, v + (Math.random() * 40 - 20)));
            if (Math.random() > 0.8) testPattern.push(Math.random() * 100); // たまに要素を増やす
            
            document.getElementById('currentPattern').innerText = JSON.stringify(testPattern.map(Math.floor));

            // 2. 実際に震わせる
            navigator.vibrate(testPattern);

            // 3. 振動中の最大加速度を計測 (500ms間)
            let maxAccDuringTrial = 0;
            const startTime = Date.now();
            while (Date.now() - startTime < 600) {
                if (currentAccel > maxAccDuringTrial) maxAccDuringTrial = currentAccel;
                await new Promise(r => setTimeout(r, 10));
            }

            // 4. 評価 (報酬の計算)
            if (maxAccDuringTrial > bestScore) {
                bestScore = maxAccDuringTrial;
                bestPattern = testPattern;
                updateLog(`進化！新スコア: ${bestScore.toFixed(2)}`);
                document.getElementById('bestScore').innerText = bestScore.toFixed(2);
            }

            // 次の試行へ
            setTimeout(runTrial, 200);
        }

        function updateLog(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `> ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            isLearning = !isLearning;
            this.innerText = isLearning ? "ストップ" : "学習開始 (Android用)";
            if (isLearning) {
                updateLog("学習を開始しました...");
                runTrial();
            }
        });
    </script>
</body>
</html>
