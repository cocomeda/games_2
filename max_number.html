<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>最大数タップゲーム</title>

<style>
:root {
    --bg:#0f1220;
    --panel:#1a1e35;
    --cell:#242862;
    --accent:#4cc9f0;
    --danger:#ff4d6d;
    --text:#fff;
    --muted:#9aa0c4;
}

* { box-sizing:border-box; }

body {
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui, sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}

.container {
    width:100%;
    max-width:520px;
    padding:24px;
    text-align:center;
}

h1 { font-size:26px; margin-bottom:10px; }
#info { font-size:18px; color:var(--muted); margin-bottom:18px; }

.controls {
    display:flex;
    justify-content:center;
    gap:12px;
    margin-bottom:20px;
}
.controls button {
    background:var(--panel);
    color:var(--text);
    border:none;
    padding:12px 20px;
    border-radius:14px;
    font-size:18px;
    cursor:pointer;
}
.controls button.active {
    background:var(--accent);
    color:#000;
    font-weight:700;
}

.start-btn {
    margin:24px auto;
    padding:18px;
    width:80%;
    max-width:260px;
    font-size:22px;
    font-weight:800;
    border-radius:18px;
    border:none;
    background:var(--accent);
    color:#000;
    cursor:pointer;
}

.grid { display:grid; gap:18px; margin-top:20px; }
.grid.four { grid-template-columns:repeat(2,1fr); }
.grid.nine { grid-template-columns:repeat(3,1fr); }

.cell {
    background:var(--cell);
    border-radius:18px;
    font-size:42px;
    font-weight:800;
    padding:38px 0;
    cursor:pointer;
    transition:transform .05s;
}
.cell:active { transform:scale(.96); }
.cell.disabled { pointer-events:none; opacity:.5; }
.cell.correct { outline:5px solid var(--accent); }

.overlay {
    position:fixed; inset:0;
    background:rgba(0,0,0,.85);
    display:none; justify-content:center; align-items:center;
    z-index:10;
}
.overlay.show { display:flex; }
.overlay-box {
    background:var(--panel);
    padding:40px 28px;
    border-radius:22px;
    width:90%; max-width:420px;
}
.overlay h2 { font-size:36px; margin-bottom:12px; }
.overlay h2.gameover { color:var(--danger); }
.result-label { font-size:14px; color:var(--muted); letter-spacing:.08em; margin-top:14px; }
.result-value { font-size:44px; font-weight:800; margin-top:6px; color:var(--accent); }
.retry { margin-top:26px; width:100%; padding:16px; font-size:18px; font-weight:700; border:none; border-radius:16px; background:var(--accent); cursor:pointer; }
</style>
</head>
<body>
<div class="container">

<h1>一番大きい数字をタップ</h1>
<div id="info">マス数を選んで START</div>

<div class="controls">
    <button id="btn4">4</button>
    <button id="btn9" class="active">9</button>
</div>

<button class="start-btn" id="startBtn">START</button>
<div class="grid nine" id="grid"></div>
</div>

<div class="overlay" id="overlay">
    <div class="overlay-box">
        <h2 id="overlayTitle"></h2>
        <div id="stats"></div>
        <button class="retry" onclick="location.reload()">RETRY</button>
    </div>
</div>

<script>
const TOTAL_TRIALS=100;
const MAX_MISS=10;

let gridSize=9, currentTrial=1, missCount=0, reactionTimes=[], startTime=0, started=false;
const grid=document.getElementById("grid");
const info=document.getElementById("info");
const overlay=document.getElementById("overlay");
const overlayTitle=document.getElementById("overlayTitle");
const stats=document.getElementById("stats");
const startBtn=document.getElementById("startBtn");

document.getElementById("btn4").onclick=()=>setGrid(4);
document.getElementById("btn9").onclick=()=>setGrid(9);
startBtn.onclick=startGame;

function setGrid(size){
    if(started) return;
    gridSize=size;
    document.getElementById("btn4").classList.toggle("active",size===4);
    document.getElementById("btn9").classList.toggle("active",size===9);
    grid.className="grid "+(size===4?"four":"nine");
}

function startGame(){
    if(started) return;
    started=true;
    startBtn.style.display="none";
    document.querySelector(".controls").style.display="none";
    startTrial();
}

function uniqueNumbers(count){
    const set=new Set();
    while(set.size<count){ set.add(Math.floor(Math.random()*90)+10); }
    return [...set];
}

function startTrial(){
    grid.replaceChildren();
    const nums=uniqueNumbers(gridSize);
    const max=Math.max(...nums);

    // 描画後にタイマー開始
    requestAnimationFrame(()=>{ startTime=performance.now(); });

    nums.forEach(n=>{
        const d=document.createElement("div");
        d.className="cell";
        d.textContent=n;
        d.onclick=()=>handleClick(d,n,max);
        grid.appendChild(d);
    });

    info.textContent=`Trial ${currentTrial} / ${TOTAL_TRIALS}`;
}

function handleClick(cell,num,max){
    document.querySelectorAll(".cell").forEach(c=>c.classList.add("disabled"));

    if(num===max){
        reactionTimes.push((performance.now()-startTime)/1000);
        currentTrial++;
        if(currentTrial>TOTAL_TRIALS){ finishGame(); }
        else requestAnimationFrame(startTrial);
    } else {
        missCount++;
        document.querySelectorAll(".cell").forEach(c=>{ if(+c.textContent===max)c.classList.add("correct"); });
        if(missCount>=MAX_MISS) gameOver();
        else requestAnimationFrame(startTrial);
    }
}

function finishGame(){
    const mean=reactionTimes.reduce((a,b)=>a+b)/reactionTimes.length;
    const variance=reactionTimes.reduce((a,b)=>a+(b-mean)**2,0)/reactionTimes.length;
    const sd=Math.sqrt(variance);
    const filtered=reactionTimes.filter(t=>Math.abs(t-mean)<=2*sd);
    const avg=filtered.reduce((a,b)=>a+b)/filtered.length;

    overlay.classList.add("show");
    overlayTitle.textContent="CLEAR";
    stats.innerHTML=`
        <div class="result-label">AVERAGE REACTION</div>
        <div class="result-value">${avg.toFixed(3)} s</div>`;
}

function gameOver(){
    overlay.classList.add("show");
    overlayTitle.textContent="GAME OVER";
    overlayTitle.classList.add("gameover");
    stats.innerHTML=`
        <div class="result-label">MISSES</div>
        <div class="result-value">${missCount}</div>`;
}
</script>
</body>
</html>
