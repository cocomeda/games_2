<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reaction Max</title>

<style>
:root {
    --bg: #0f1115;
    --panel: #181b22;
    --cell: #222633;
    --accent: #4fd1c5;
    --text: #e5e7eb;
    --muted: #9ca3af;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    min-height: 100vh;
    background: linear-gradient(160deg, #0f1115, #121826);
    font-family: "Inter", system-ui, sans-serif;
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: center;
}

.app {
    width: 100%;
    max-width: 420px;
    padding: 24px;
}

h1 {
    text-align: center;
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 16px;
    letter-spacing: 0.05em;
}

.control {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--panel);
    padding: 12px 14px;
    border-radius: 14px;
    margin-bottom: 14px;
}

select, button {
    background: var(--cell);
    color: var(--text);
    border: none;
    border-radius: 10px;
    padding: 8px 14px;
    font-size: 14px;
}

button {
    cursor: pointer;
    background: var(--accent);
    color: #0f1115;
    font-weight: 600;
}

#info {
    text-align: center;
    font-size: 13px;
    color: var(--muted);
    margin: 10px 0;
}

.grid {
    display: grid;
    gap: 14px;
    margin-top: 14px;
}

.cell {
    background: var(--cell);
    border-radius: 16px;
    text-align: center;
    font-size: 28px;
    font-weight: 600;
    padding: 26px 0;
    cursor: pointer;
    transition: transform 0.08s ease, background 0.08s ease;
}

.cell:hover {
    transform: translateY(-2px);
}

.disabled {
    pointer-events: none;
    opacity: 0.4;
}

.correct {
    outline: 3px solid var(--accent);
}

/* overlay */
#overlay {
    position: fixed;
    inset: 0;
    background: rgba(15,17,21,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

#overlayContent {
    background: var(--panel);
    padding: 28px 32px;
    border-radius: 20px;
    width: 90%;
    max-width: 360px;
    text-align: center;
}

#overlayContent h2 {
    margin: 0 0 10px;
    font-size: 28px;
}

#stats {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 16px;
}

#overlayContent button {
    width: 100%;
}
</style>
</head>

<body>

<div class="app">
    <h1>REACTION MAX</h1>

    <div class="control">
        <div>
            Grid
            <select id="gridSizeSelect">
                <option value="9">3×3</option>
                <option value="4">2×2</option>
            </select>
        </div>
        <button onclick="startGame()">START</button>
    </div>

    <div id="info"></div>
    <div class="grid" id="grid"></div>
</div>

<div id="overlay">
    <div id="overlayContent">
        <h2 id="overlayText"></h2>
        <div id="stats"></div>
        <button onclick="retry()">RETRY</button>
    </div>
</div>

<script>
const TOTAL_TRIALS = 100;
const MAX_MISSES = 10;

let currentTrial = 0;
let missCount = 0;
let numbers = [];
let maxNumber = 0;
let trialStart = 0;
let reactions = [];
let gameActive = false;

const grid = document.getElementById("grid");
const info = document.getElementById("info");
const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");
const stats = document.getElementById("stats");
const gridSizeSelect = document.getElementById("gridSizeSelect");

const rand = () => Math.floor(Math.random() * 90) + 10;

function startGame() {
    currentTrial = 1;
    missCount = 0;
    reactions = [];
    gameActive = true;
    overlay.style.display = "none";
    startTrial();
}

function startTrial() {
    if (!gameActive) return;

    grid.innerHTML = "";
    numbers = [];

    const size = Number(gridSizeSelect.value);
    grid.style.gridTemplateColumns = `repeat(${size === 9 ? 3 : 2}, 1fr)`;

    while (numbers.length < size) {
        const n = rand();
        if (!numbers.includes(n)) numbers.push(n);
    }

    maxNumber = Math.max(...numbers);

    numbers.forEach(n => {
        const c = document.createElement("div");
        c.className = "cell";
        c.textContent = n;
        c.onclick = () => tap(n);
        grid.appendChild(c);
    });

    trialStart = performance.now();
    info.textContent = `Trial ${currentTrial} / ${TOTAL_TRIALS}  ·  Miss ${missCount}/${MAX_MISSES}`;
}

function tap(n) {
    document.querySelectorAll(".cell").forEach(c => c.classList.add("disabled"));

    const rt = (performance.now() - trialStart) / 1000;

    if (n === maxNumber) {
        reactions.push(rt);
        currentTrial++;

        if (currentTrial > TOTAL_TRIALS) finish();
        else setTimeout(startTrial, 120);
    } else {
        missCount++;
        document.querySelectorAll(".cell").forEach(c => {
            if (+c.textContent === maxNumber) c.classList.add("correct");
        });

        if (missCount >= MAX_MISSES) gameOver();
        else setTimeout(startTrial, 400);
    }
}

function finish() {
    const avg = calcAverage(reactions);
    overlayText.textContent = "CLEAR";
    stats.innerHTML = `Average Reaction<br><b>${avg.toFixed(3)} s</b>`;
    overlay.style.display = "flex";
}

function gameOver() {
    overlayText.textContent = "GAME OVER";
    stats.innerHTML = `Trial ${currentTrial}<br>Miss ${missCount}`;
    overlay.style.display = "flex";
}

function retry() {
    gameActive = false;
    grid.innerHTML = "";
    info.textContent = "";
    overlay.style.display = "none";
}

function calcAverage(arr) {
    const m = arr.reduce((a,b)=>a+b,0)/arr.length;
    const v = arr.reduce((s,x)=>s+(x-m)**2,0)/arr.length;
    const sd = Math.sqrt(v);
    const filtered = arr.filter(x => x >= m-2*sd && x <= m+2*sd);
    return filtered.reduce((a,b)=>a+b,0)/filtered.length;
}
</script>

</body>
</html>
