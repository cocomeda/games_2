<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>1 to N 数字タップゲーム </title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --bg: #f8f9fa;
    --panel: #ffffff;
    --accent: #007bff;
    --danger: #dc3545;
    --success: #28a745;
    --secondary: #6c757d;
    --text: #333;
}

body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; background: var(--bg); margin: 0; padding: 10px; user-select: none; color: var(--text); }
.container { width: 100%; max-width: 600px; margin: 0 auto; padding: 15px; background: var(--panel); border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); box-sizing: border-box; }

/* ゲームグリッド */
.number-grid { display: grid; gap: 8px; margin: 20px auto; background: #eee; padding: 10px; border-radius: 12px; touch-action: none; }
.num-btn { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; background: white; border-radius: 8px; font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.05s; }
.num-btn:active { transform: scale(0.9); background: #f0f0f0; }
.num-btn.pressed { background: #e0e0e0; color: #aaa; box-shadow: none; }

/* タブ UI */
.tabs { display: flex; justify-content: center; margin-bottom: 10px; border-bottom: 2px solid #ddd; }
.tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; color: #666; }
.tab.active { border-color: var(--accent); color: var(--accent); }

/* 一括操作エリア */
.selection-controls { display: flex; align-items: center; padding: 0 10px 10px; font-size: 0.9em; color: #666; }
.selection-controls input { margin-right: 8px; transform: scale(1.2); }

/* 履歴リスト */
.history-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; font-size: 0.85em; text-align: left; }
.history-info { flex-grow: 1; margin: 0 10px; }
.del-btn { color: var(--danger); border: 1px solid var(--danger); background: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; }

/* ヒートマップ */
.heatmap-container { display: grid; gap: 4px; margin: 15px auto; max-width: 250px; border: 3px solid #444; padding: 4px; background: #444; }
.heat-cell { aspect-ratio: 1/1; font-size: 0.6em; display: flex; align-items: center; justify-content: center; font-weight: bold; }

.control-btn { padding: 14px; width: 100%; border: none; border-radius: 12px; background: var(--accent); color: white; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 1em; }
.sub-btn { padding: 10px; border-radius: 8px; border: 1px solid #ccc; background: white; font-size: 0.85em; cursor: pointer; flex: 1; margin: 0 5px; }

#result-screen { display: none; }
</style>
</head>
<body>

<div class="container">
    <div id="setup-area">
        <h1>1 to N 数字タップゲーム</h1>
        <div style="margin-bottom: 20px;">
            <label>マス数選択：</label>
            <select id="gridSizeSelect" style="padding:10px; border-radius:8px;" onchange="saveConfig()">
                <option value="9">9 (3×3)</option>
                <option value="16">16 (4×4)</option>
                <option value="25">25 (5×5)</option>
                <option value="36">36 (6×6)</option>
            </select>
        </div>
        <button class="control-btn" onclick="startGame()">ゲーム開始</button>
    </div>

    <div id="game-area" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button onclick="exitGame()" style="padding:5px 15px; border-radius:8px; border:1px solid #ccc; background:white;">戻る</button>
            <div id="targetDisplay" style="font-weight:bold; color:var(--accent);">Next: 1</div>
            <div id="timer" style="font-family:monospace; font-size:1.2em;">0.00</div>
        </div>
        <div id="numberGrid" class="number-grid"></div>
    </div>

    <div id="result-screen">
        <h2 id="resultTitle">分析結果</h2>
        <div id="heatmapGrid" class="heatmap-container"></div>
        <div style="height:250px; margin-bottom:20px;"><canvas id="speedChart"></canvas></div>
        <button class="control-btn" onclick="location.reload()">ホームへ戻る</button>
    </div>

    <div id="history-section" style="margin-top:30px;">
        <h3>過去のデータ</h3>
        <div class="tabs" id="sizeTabs">
            <div class="tab" onclick="changeTab(9)">9</div>
            <div class="tab" onclick="changeTab(16)">16</div>
            <div class="tab" onclick="changeTab(25)">25</div>
            <div class="tab" onclick="changeTab(36)">36</div>
        </div>
        
        <div id="batchControl" class="selection-controls" style="display:none;">
            <label style="cursor:pointer; display:flex; align-items:center;">
                <input type="checkbox" id="selectAllHistory" onclick="toggleSelectAll(this.checked)"> 全選択 / 解除
            </label>
        </div>

        <div id="historyList" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
        
        <div id="actionButtons" style="display:none;">
            <button class="control-btn" style="background:var(--success); margin-bottom: 5px;" onclick="analyzeSelected()">選択したデータを統合分析</button>
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <button class="sub-btn" onclick="exportData('json')">JSON保存</button>
                <button class="sub-btn" onclick="exportData('csv')">CSV書出</button>
            </div>
        </div>
    </div>
</div>

<script>
let nextNumber = 1, startTime, lastTapTime, tapLogs = [], isGameActive = false, MAX_NUMBER = 25, speedChart = null, currentTabSize = 25;
const STORAGE_KEY = "1toN_spatial_v4";
const CONFIG_KEY = "1toN_config";

function init() {
    const savedSize = localStorage.getItem(CONFIG_KEY);
    if (savedSize) {
        document.getElementById('gridSizeSelect').value = savedSize;
        currentTabSize = parseInt(savedSize);
    }
    changeTab(currentTabSize);
}

function saveConfig() {
    const size = document.getElementById('gridSizeSelect').value;
    localStorage.setItem(CONFIG_KEY, size);
}

function exitGame() {
    if(confirm("進行中のデータを破棄して戻りますか？")) location.reload();
}

function startGame() {
    MAX_NUMBER = parseInt(document.getElementById('gridSizeSelect').value);
    const size = Math.sqrt(MAX_NUMBER);
    const grid = document.getElementById('numberGrid');
    grid.style.setProperty('--grid-size', size);
    grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
    grid.innerHTML = '';

    let numbers = Array.from({length: MAX_NUMBER}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
    numbers.forEach((num, index) => {
        const btn = document.createElement('div');
        btn.className = 'num-btn';
        btn.textContent = num;
        btn.style.fontSize = (40 / size) + "vw";
        const handle = (e) => { if(e.cancelable) e.preventDefault(); handleNumberClick(num, index); };
        btn.addEventListener('touchstart', handle, {passive:false});
        btn.addEventListener('mousedown', handle);
        grid.appendChild(btn);
    });

    document.getElementById('setup-area').style.display = 'none';
    document.getElementById('history-section').style.display = 'none';
    document.getElementById('game-area').style.display = 'block';
    
    nextNumber = 1; tapLogs = []; isGameActive = true;
    startTime = Date.now(); lastTapTime = startTime;
    timerInterval = setInterval(() => {
        document.getElementById('timer').textContent = ((Date.now() - startTime) / 1000).toFixed(2);
    }, 10);
}

function handleNumberClick(num, posIndex) {
    if (!isGameActive || num !== nextNumber) return;
    const now = Date.now();
    tapLogs.push({ num, time: (now - lastTapTime) / 1000, pos: posIndex });
    lastTapTime = now;
    document.querySelectorAll('.num-btn')[posIndex].classList.add('pressed');
    if (nextNumber === MAX_NUMBER) finishGame();
    else { nextNumber++; document.getElementById('targetDisplay').textContent = "Next: " + nextNumber; }
}

function finishGame() {
    clearInterval(timerInterval);
    isGameActive = false;
    const finalTime = document.getElementById('timer').textContent;
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    history.unshift({ id: Date.now(), date: new Date().toLocaleString('ja-JP', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}), time: finalTime, size: MAX_NUMBER, logs: tapLogs });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    showResult([tapLogs], MAX_NUMBER, "結果: " + finalTime + "sec");
}

function changeTab(size) {
    currentTabSize = size;
    document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', parseInt(t.innerText) === size);
    });
    document.getElementById('selectAllHistory').checked = false;
    displayHistory();
}

function toggleSelectAll(isChecked) {
    const checkboxes = document.querySelectorAll('.history-chk');
    checkboxes.forEach(cb => cb.checked = isChecked);
}

function displayHistory() {
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    const filtered = history.filter(h => h.size === currentTabSize);
    const list = document.getElementById('historyList');
    const actionArea = document.getElementById('actionButtons');
    const batchControl = document.getElementById('batchControl');

    const hasData = filtered.length > 0;
    actionArea.style.display = hasData ? "block" : "none";
    batchControl.style.display = hasData ? "flex" : "none";

    list.innerHTML = filtered.map((item) => `
        <div class="history-item">
            <input type="checkbox" class="history-chk" data-id="${item.id}">
            <div class="history-info" onclick="viewSingleData(${item.id})" style="cursor:pointer;">
                <strong>${item.time}s</strong> <small>(${item.date})</small>
            </div>
            <button class="del-btn" onclick="deleteData(${item.id})">削除</button>
        </div>
    `).join('') || `<p style="color:#999; padding:20px;">${currentTabSize}マスのデータはありません</p>`;
}

function deleteData(id) {
    if(!confirm("このデータを削除しますか？")) return;
    let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    history = history.filter(h => h.id !== id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    displayHistory();
}

function exportData(type) {
    const checked = document.querySelectorAll('.history-chk:checked');
    if (checked.length === 0) return alert("保存するデータを選択してください");
    
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY));
    const selectedIds = Array.from(checked).map(c => parseInt(c.dataset.id));
    const selectedData = history.filter(h => selectedIds.includes(h.id));

    let content = "";
    let mimeType = "";
    let fileName = `1toN_data_${new Date().getTime()}`;

    if (type === 'json') {
        content = JSON.stringify(selectedData, null, 2);
        mimeType = "application/json";
        fileName += ".json";
    } else {
        // CSV作成：ヘッダー（日付, 合計, 1, 2, 3...）
        const header = ["Date", "TotalTime", ...Array.from({length: currentTabSize}, (_, i) => i + 1)];
        const rows = selectedData.map(d => [
            d.date, d.time, ...d.logs.map(l => l.time)
        ]);
        content = [header, ...rows].map(r => r.join(",")).join("\n");
        mimeType = "text/csv";
        fileName += ".csv";
    }

    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);
}

function viewSingleData(id) {
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    const data = history.find(h => h.id === id);
    showResult([data.logs], data.size, "個別データ確認: " + data.time + "s");
}

function analyzeSelected() {
    const checked = document.querySelectorAll('.history-chk:checked');
    if (checked.length === 0) return alert("分析するデータを選択してください");
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY));
    const selectedIds = Array.from(checked).map(c => parseInt(c.dataset.id));
    const selectedLogs = history.filter(h => selectedIds.includes(h.id)).map(h => h.logs);
    showResult(selectedLogs, currentTabSize, checked.length + "件の統合分析(タップ1は除外)");
}

function showResult(allLogs, size, title) {
    document.getElementById('game-area').style.display = 'none';
    document.getElementById('setup-area').style.display = 'none';
    document.getElementById('history-section').style.display = 'none';
    document.getElementById('result-screen').style.display = 'block';
    document.getElementById('resultTitle').innerText = title;

    const posStats = new Array(size).fill(0).map(() => []);

    allLogs.forEach(logs => {
        logs.forEach(log => {
            if (log.num !== 1) { 
                posStats[log.pos].push(log.time); // 閉じカッコを修正
            }
        }); // 閉じタグを修正
    });

    const posAverages = posStats.map(times => times.length ? times.reduce((a, b) => a + b, 0) / times.length : 0);
    
    const maxPosTime = Math.max(...posAverages);
    const minPosTime = Math.min(...posAverages.filter(a => a > 0) || [0]); // 0除算回避
    const heatmap = document.getElementById('heatmapGrid');
    const gridSize = Math.sqrt(size);
    heatmap.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
    heatmap.innerHTML = posAverages.map(avg => {
        const ratio = maxPosTime === minPosTime ? 0 : (avg - minPosTime) / (maxPosTime - minPosTime);
        const color = avg === 0 ? "#fff" : `rgb(255, ${255 * (1 - ratio)}, ${255 * (1 - ratio)})`;
        return `<div class="heat-cell" style="background:${color}">${avg ? avg.toFixed(2) : '-'}</div>`;
    }).join('');

    const datasets = [];
    const labels = Array.from({length: size}, (_, i) => i + 1);

    allLogs.forEach((logs, idx) => {
        datasets.push({
            label: `試行 ${idx + 1}`,
            data: logs.map(l => l.time),
            borderColor: 'rgba(0, 123, 255, 0.08)',
            borderWidth: 1,
            pointRadius: 0,
            fill: false,
            tension: 0.3
        });
    });

    const means = [];
    const sdUpper = [];
    const sdLower = [];
    for (let i = 0; i < size; i++) {
        const vals = allLogs.map(logs => logs[i]?.time).filter(v => v !== undefined);
        const avg = vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
        const variance = vals.length ? vals.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / vals.length : 0;
        const sd = Math.sqrt(variance);
        means.push(avg);
        sdUpper.push(avg + sd);
        sdLower.push(Math.max(0, avg - sd));
    }

    datasets.push({ label: '+1 SD', data: sdUpper, fill: '+1', backgroundColor: 'rgba(0, 123, 255, 0.05)', borderColor: 'transparent', pointRadius: 0, tension: 0.3 });
    datasets.push({ label: '-1 SD', data: sdLower, fill: false, borderColor: 'transparent', pointRadius: 0, tension: 0.3 });
    datasets.push({ label: '平均秒数', data: means, borderColor: '#007bff', borderWidth: 3, pointRadius: 2, fill: false, tension: 0.3 });

    // speedChartがグローバルまたは外部で定義されていない場合の対策
    if (typeof speedChart !== 'undefined' && speedChart) {
        speedChart.destroy();
    }

    // Chart.jsのインスタンス作成（speedChart変数に代入）
    window.speedChart = new Chart(document.getElementById('speedChart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    filter: (item) => item.dataset.label === '平均秒数',
                    callbacks: { label: (ctx) => `平均: ${ctx.raw.toFixed(3)}s` }
                }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: '秒' } },
                x: { title: { display: true, text: 'タップ順' } }
            }
        }
    });
}

window.onload = init;
</script>
</body>
</html>
